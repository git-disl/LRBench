{% extends "common.html" %} 
{% load static %}
{% load crispy_forms_tags %}

{% block content %}

{% block body %}
<br>
<div class="container col-6">
  <form class ="form-horizontal"action="" method="post" id="post-form">
    {% csrf_token %}
    <!-- Main form -->
    {{ form | crispy }} 
    {{ formset.management_form }}
    <!-- dynamic formsets -->
    {% for form1 in formset %}

    <div id= 'main_div' name='{{ forloop.counter0 }}' class= 'form-row input-group'>

      <div class="row">  
       <div class="col">  
        {{ form1.lrPolicy | as_crispy_field }}   
      </div>
      <div class="col">  
        {{ form1.epochs | as_crispy_field }}   
      </div>
    </div>
    <div class="row input-group">  
      <div class="col">  
        {{ form1.k0 | as_crispy_field }}
      </div>
      <div class="col">  
        {{ form1.k1 | as_crispy_field }}   
      </div>
      <div class="col">  
        {{ form1.p | as_crispy_field }}
      </div>
      <div class="col">  
        {{ form1.l | as_crispy_field }}   
      </div>
      <div class="col">  
        {{ form1.gamma | as_crispy_field }}
      </div>

      <div class="col" style="margin-top:30px">
        <button id="add_btn" name="add_btn" class="btn btn-success add-form-row">+</button>  
      </div>

    </div>

  </div>

  <br> 
  {% endfor %}

  <input class="btn btn-outline-primary" type="submit" value="Submit" id="submit_button">
</form>    
<br>
<a href="{% url 'blog-results' %}"><button class="btn btn-outline-primary" id="show_results_button" style="display:none" >Show Results</button></a>

</div>


<!-- scripts to handle varoius functionalities -->
<script type='text/javascript'>

// Enable the view results button on ly on form submit
// Disable the submit button so that another request is not sent
$('#post-form').on('submit', function(event){
  document.getElementById("submit_button").disabled=true
  document.getElementById("show_results_button").style.display="block"
 }); 

// Variables to change the field when user enters LR type
var k0=["FIX"]
var k0_gamma_l = ["STEP","NSTEP","SIG"];
var k0_gamma = ["EXP"];
var k0_gamma_p = ["INV"];
var k0_k1_gamma_l = ["TRIEXP","DTRIEXP"];
var k0_k1_l= ["TRI","SIN"];
var k0_k1_p_l=[];

// Display the appropriate fields on LR policy change
// Disable the others
// Validate if the corresponding fields are present on submit
function lr_policy_change(ele){
  name=ele.name
  prefix=name.substr(0, name.indexOf('l'))
  value=ele.value

  epochs_div=document.getElementsByName(prefix+"epochs")[0]
  k0_div=document.getElementsByName(prefix+"k0")[0]
  k1_div=document.getElementsByName(prefix+"k1")[0]
  gamma_div=document.getElementsByName(prefix+"gamma")[0]
  p_div=document.getElementsByName(prefix+"p")[0]
  l_div=document.getElementsByName(prefix+"l")[0]

  k0_div.required=true
  k1_div.disabled = true;
  (gamma_div).disabled = true;
  (p_div).disabled = true;
  (l_div).disabled = true;
  (k1_div).required = false;
  (gamma_div).required = false;
  (p_div).required = false;
  (l_div).required = false;

//enabling gamma
if(k0_gamma_l.includes(value) || k0_gamma.includes(value) ||  
  k0_gamma_p.includes(value) || k0_k1_gamma_l.includes(value))
{

  (gamma_div).disabled = false;
  (gamma_div).required = true;
  
}

//enabling l
if(k0_gamma_l.includes(value) || k0_k1_p_l.includes(value) ||  
  k0_k1_l.includes(value) || k0_k1_gamma_l.includes(value))
{
  (l_div).disabled = false;
  (l_div).required = true;
}

//enabling k1
if( k0_k1_p_l.includes(value) ||  
  k0_k1_l.includes(value) || k0_k1_gamma_l.includes(value))
{
  (k1_div).disabled = false;
  (k1_div).required = true;
}

//enabling p
if(k0_gamma_p.includes(value) || k0_k1_p_l.includes(value))
{
  (p_div).disabled = false;
  (p_div).required = true;
}
}


//Formset addition and deletion function
//source: https://medium.com/all-about-django/adding-forms-dynamically-to-a-django-formset-375f1090c2b0

function updateElementIndex(el, prefix, ndx) {
var id_regex = new RegExp('(' + prefix + '-\\d+)');
var replacement = prefix + '-' + ndx;
if ($(el).attr("for")) $(el).attr("for", $(el).attr("for").replace(id_regex, replacement));
if (el.id) el.id = el.id.replace(id_regex, replacement);
if (el.name) el.name = el.name.replace(id_regex, replacement);
}
function cloneMore(selector, prefix) {

var newElement = $(selector).clone(true);

var total = $('#id_' + prefix + '-TOTAL_FORMS').val();

newElement.find(':input:not([type=button]):not([type=submit]):not([type=reset])').each(function() {
  var name = $(this).attr('name').replace('-' + (total-1) + '-', '-' + total + '-');
  var id = 'id_' + name;
  $(this).attr({'name': name, 'id': id}).val('').removeAttr('checked');
  if (id.includes('lr')) //set defualt value of dropdown to FIX
  {
    $(this).attr({'name': name, 'id': id}).val('FIX')        
  }
  if (!id.includes('lr')&& !id.includes('epochs') && !id.includes('k0') &&
   !$(this).is("button")) //disable all fileds except k0, dropdown and add button
  {
    $(this).attr({'disabled':true})
    console.log($(this))        
  }

});
newElement.find('label').each(function() {
  var forValue = $(this).attr('for');
  if (forValue) {
    forValue = forValue.replace('-' + (total-1) + '-', '-' + total + '-');
    $(this).attr({'for': forValue});
  }
});
total++;
$('#id_' + prefix + '-TOTAL_FORMS').val(total);
$(selector).after(newElement);
var conditionRow = $('.form-row:not(:last)');
conditionRow.find('.btn.add-form-row')
.removeClass('btn-success').addClass('btn-danger')
.removeClass('add-form-row').addClass('remove-form-row')
.html('-');
return false;
}
function deleteForm(prefix, btn) {
var total = parseInt($('#id_' + prefix + '-TOTAL_FORMS').val());
if (total > 1){
  btn.closest('.form-row').remove();
  var forms = $('.form-row');
  $('#id_' + prefix + '-TOTAL_FORMS').val(forms.length);
  for (var i=0, formCount=forms.length; i<formCount; i++) {
    $(forms.get(i)).find(':input').each(function() {
      updateElementIndex(this, prefix, i);
    });
  }
}
return false;
}
$(document).on('click', '.add-form-row', function(e){
e.preventDefault();
cloneMore('.form-row:last', 'form');
return false;
});
$(document).on('click', '.remove-form-row', function(e){
e.preventDefault();
deleteForm('form', $(this));
return false;
});


</script>

{% endblock body %}
{% endblock content %}
